CREATE OR ALTER TRIGGER AFTER_INSERT_TRIGGER ON HISTORY_PRODUCT
AFTER INSERT
AS
BEGIN
	DECLARE 
		@TEMP AS TABLE(
			ROW_N INT,
			PRODUCT_ID INT,

			WAREHOUSE_ID INT,
			COUNT INT
		)
	DECLARE
		@PRODUCT_ID INT,
		@WAREHOUSE_ID INT,
		@COUNT INT

	INSERT INTO @TEMP
	SELECT ROW_NUMBER() OVER(ORDER BY COUNT ASC), PRODUCT_ID, WAREHOUSE_ID, COUNT FROM INSERTED

	WHILE Exists
	(
		select 1 
		from @TEMP
	)
	begin
		declare @TEMP_ID INT;
	
		SELECT TOP 1 
			@TEMP_ID = ROW_N, 
			@PRODUCT_ID = PRODUCT_ID,
			@WAREHOUSE_ID = WAREHOUSE_ID,
			@COUNT = COUNT
		from @TEMP 

		EXECUTE CHANGE_PRODUCT_WAREHOUSE_LINK @PRODUCT_ID, @WAREHOUSE_ID, @COUNT

		delete 
		from @TEMP
		where ROW_N = @TEMP_ID
	end
END;

CREATE OR ALTER TRIGGER INSTEAD_DELETE_TRIGGER ON HISTORIES
INSTEAD OF DELETE
AS
BEGIN

	SET NOCOUNT ON;
	UPDATE HISTORIES
	SET IS_DELETED = 1
	WHERE ID IN (SELECT ID FROM DELETED)

END;


CREATE OR ALTER TRIGGER INSTEAD_DELETE_PRODUCTS_TRIGGER ON PRODUCTS
INSTEAD OF DELETE
AS
BEGIN

	SET NOCOUNT ON;
	UPDATE PRODUCTS
	SET IS_DELETED = 1
	WHERE ID IN (SELECT ID FROM DELETED)

END;